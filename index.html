<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adventure with Butterflies</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-family: "Arial", sans-serif;
      height: 100vh;
      overflow: hidden;
      background: #f0f0f0;
      text-align: center;
      position: relative;
    }

    .page {
      width: 100vw;
      height: 100vh;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-color: #000000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    #homePage {
      background-image: url('mean.png');
      display: flex;
    }

    #gamePage {
      background-image: url('กติกา.png');
    }

    #namePage {
      background-image: url('กรอกชื่อ.png');
    }

    #mapPage {
      background-image: url('map.png');
      display: flex;
    }

    button {
      font-weight: bold;
      border: none;
      border-radius: 12px;
      padding: 1em 2em;
      font-size: 1.2em;
      cursor: pointer;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    button:hover {
      filter: brightness(0.9);
      transform: scale(1.05);
    }

    .start-button,
    .next-button,
    .submit-button {
      background-color: #f1c40f;
      color: #222;
      position: absolute;
      bottom: 15%;
      left: 50%;
      transform: translateX(-50%);
    }

    .input-name {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      padding: 1em;
      font-size: 1.2em;
      border-radius: 10px;
      border: 2px solid #ccc;
      width: 250px;
      max-width: 80vw;
    }

    #nicknameDisplay {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.5em;
      font-weight: 600;
      color: black;
      text-shadow: 1px 1px 2px white;
      z-index: 20;
    }

    /* ปุ่มกล้อง */
    #cameraBtn {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 60px;
      background: transparent;
      border: none;
      cursor: pointer;
      display: none;
      z-index: 30;
    }

    #cameraBtn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Popup สแกน QR */
    #scanner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #reader {
      width: 320px;
      max-width: 90vw;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px #f1c40f;
      background: #fff;
    }

    .map-container {
      position: relative;
      width: 90vw;
      /* หรือขนาดที่ต้องการให้เหมาะกับจอ */
      max-width: 700px;
      aspect-ratio: 3 / 4;
      /* ปรับตามอัตราส่วนของ map.png จริง */
      margin: 0 auto;
    }

    /* ✅ รูปภาพแผนที่ */
    .map-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* ✅ Checkmark จะอิงกับ .map-container */
    .checkmark {
      position: absolute;
      font-size: 2em;
      color: green;
      display: none;
      z-index: 10;
    }

    /* ปรับตำแหน่งแต่ละด่านจากภาพ map.png */
    #check1 {
      top: 72%;
      left: 78%;
    }

    /* ด่าน 1: Tiny Insect Village */
    #check2 {
      top: 34%;
      left: 82%;
    }

    /* ด่าน 2: Economic Insects */
    #check3 {
      top: 17%;
      left: 50%;
    }

    /* ปุ่มรีเซ็ต */
    .reset-button {
      position: absolute;
      bottom: 3%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #e74c3c;
      color: white;
      padding: 0.7em 1.5em;
      font-size: 1.1em;
      z-index: 30;
    }

    .reset-button:hover {
      background-color: #c0392b;
    }
  </style>
</head>

<body>
  <!-- หน้าเริ่มต้น -->
  <div id="homePage" class="page">
    <button class="start-button" onclick="startGame()">START</button>
  </div>

  <!-- หน้าแสดงกติกา -->
  <div id="gamePage" class="page">
    <audio id="voice" src="วิธีการเล่น.mp3"></audio>
    <button class="next-button" id="nextButton" style="display:none" onclick="goToNamePage()">ถัดไป</button>
  </div>

  <!-- หน้าใส่ชื่อ -->
  <div id="namePage" class="page">
    <input id="nickname" class="input-name" type="text" placeholder="กรุณากรอกชื่อเล่น" />
    <button class="submit-button" onclick="submitName()">ตกลง</button>
    <audio id="nameVoice" src="ชื่อ.mp3" autoplay></audio>
  </div>

  <!-- หน้าแผนที่ -->
  <div class="page" id="mapPage">
    <div id="nicknameDisplay"></div>
    <!-- Checkmark แสดงว่าทำภารกิจแล้ว -->
    <div class="checkmark" id="check1">✔</div> <!-- ด่าน 1 -->
    <div class="checkmark" id="check2">✔</div> <!-- ด่าน 2 -->
    <div class="checkmark" id="check3">✔</div> <!-- ด่าน 3 -->
  </div>
  <button class="reset-button" onclick="resetGame()">รีเซ็ตเกม</button>

  <!-- ปุ่มเปิดกล้องสแกน QR -->
  <button id="cameraBtn" onclick="openScanner()">
    <img src="https://cdn-icons-png.flaticon.com/512/747/747314.png" alt="เปิดกล้อง" />
  </button>

  <!-- Popup สแกน QR -->
  <div id="scanner" onclick="closeScanner(event)">
    <div id="reader"></div>
  </div>

  <script>
    let html5QrCode;
    let voicePlayed = false;

    function hideAllPages() {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    }

    function startGame() {
      const name = localStorage.getItem("playerName");
      if (name) {
        showMapPage(name);
      } else {
        hideAllPages();
        document.getElementById("gamePage").style.display = "flex";
        document.getElementById("nextButton").style.display = "none";
        const voice = document.getElementById("voice");

        if (!voicePlayed) {
          voice.play().catch(() => { });
          voice.onended = () => {
            document.getElementById("nextButton").style.display = "block";
            voicePlayed = true;
          };
        } else {
          document.getElementById("nextButton").style.display = "block";
        }
      }
    }

    function goToNamePage() {
      hideAllPages();
      document.getElementById("namePage").style.display = "flex";
      const nameVoice = document.getElementById("nameVoice");
      nameVoice.play().catch(() => { });
    }

    function submitName() {
      const input = document.getElementById("nickname");
      const name = input.value.trim();
      if (!name) {
        alert("กรุณากรอกชื่อเล่น");
        return;
      }
      localStorage.setItem("playerName", name);
      showMapPage(name);
    }

    function showMapPage(name) {
      hideAllPages();
      document.getElementById("mapPage").style.display = "flex";
      document.getElementById("cameraBtn").style.display = "block";
      document.getElementById("nicknameDisplay").textContent =name;
renderCheckmarks();
}
// กำหนด checkmark ตามภารกิจที่ทำแล้ว (เก็บใน localStorage)
function renderCheckmarks() {
  // สมมติเก็บสถานะเป็น object ชื่อ missionStatus
  const missionStatus = JSON.parse(localStorage.getItem("missionStatus") || "{}");
  for (let i = 1; i <= 3; i++) {
    const el = document.getElementById("check" + i);
    if (missionStatus["mission" + i]) {
      el.style.display = "block";
    } else {
      el.style.display = "none";
    }
  }
}

// ฟังก์ชันเปิดกล้องสแกน QR Code
function openScanner() {
  // หยุดเสียงพูดถ้ามี
  const voice = document.getElementById("voice");
  if (!voice.paused) {
    voice.pause();
    voice.currentTime = 0;
  }

  document.getElementById("scanner").style.display = "flex";
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrSuccess
  ).catch(e => alert("ไม่สามารถเปิดกล้องได้: " + e));
}

// ฟังก์ชันปิดกล้องสแกน QR
function closeScanner(event) {
  // ถ้าคลิกนอกกล่องสแกนปิด popup
  if (event.target.id === "scanner") {
    stopScanner();
  }
}

function stopScanner() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
      document.getElementById("scanner").style.display = "none";
    }).catch(err => {
      alert("เกิดข้อผิดพลาดในการปิดกล้อง: " + err);
    });
  } else {
    document.getElementById("scanner").style.display = "none";
  }
}

// ฟังก์ชันรับค่าจาก QR ที่สแกนได้
function qrSuccess(decodedText, decodedResult) {
  stopScanner();

  // ตรวจว่า QR ที่สแกนขึ้นต้นด้วย mission และตามด้วยตัวเลข 1-6
  const match = decodedText.match(/^mission([1-6])$/);
  if (match) {
    const missionId = match[1]; // จะได้เป็น "1", "2", ..., "6"
    markMissionComplete(missionId);

    // ไปยังหน้า HTML เช่น 1.html, 2.html, ..., 6.html
    window.location.href = `${missionId}.html`;
  } else {
    alert("QR Code นี้ไม่ถูกต้อง");
  }
}



// บันทึกสถานะทำภารกิจใน localStorage แล้วอัพเดต UI
function markMissionComplete(id) {
  const missionStatus = JSON.parse(localStorage.getItem("missionStatus") || "{}");
  missionStatus["mission" + id] = true;
  localStorage.setItem("missionStatus", JSON.stringify(missionStatus));
  renderCheckmarks();
  alert("ยินดีด้วย! คุณทำภารกิจที่ " + id + " สำเร็จแล้ว");
}

// รีเซ็ตเกม
function resetGame() {
  if (confirm("คุณต้องการรีเซ็ตเกมใช่หรือไม่? ข้อมูลทั้งหมดจะถูกลบ")) {
    localStorage.clear();
    location.reload();
  }
}
</script> </body> </html> ```