<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ - ‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 2</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5dc;
    }

    .page {
      background: url('intro2.png') center/cover no-repeat;
      width: 100%;
      max-width: 600px;
      margin: auto;
      aspect-ratio: 1080 / 1920;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      overflow: hidden;
    }

    #startBtn {
      background-color: #8B4513;
      color: white;
      padding: 16px 32px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: absolute;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: 0.3s;
      z-index: 10;
    }

    #startBtn:hover {
      background-color: #5c3c10;
    }

    #game {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      display: none;
    }

    #bgImage {
      width: 100%;
      height: auto;
      display: block;
    }

    .dot {
      position: absolute;
      width: 5vw;
      height: 5vw;
      max-width: 30px;
      max-height: 30px;
      border: 3px solid white;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transform: translate(-50%, -50%);
      z-index: 2;
    }

    canvas#lineCanvas,
    canvas#fireworks {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    #popup {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 20px;
      font-size: 20px;
      font-weight: bold;
      display: none;
      z-index: 20;
      text-align: center;
    }
  </style>
</head>

<body>
  <audio id="bgMusic" src="bgmusic.mp3" loop></audio>
  <audio id="successSound" src="success.mp3" preload="auto"></audio>
  <audio id="failSound" src="fail.mp3" preload="auto"></audio>
  <audio id="voice" src="intro2voice.mp3"></audio>
  <audio id="correctSound" src="correct.mp3"></audio>

  <div class="page" id="mainPage">
    <button id="startBtn" onclick="startMission()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>

    <div id="game">
      <img id="bgImage" src="2.png" alt="‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á" />
      <canvas id="lineCanvas"></canvas>
      <canvas id="fireworks"></canvas>
      <div id="popup"></div>

      <!-- ‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≤‡∏¢ -->
      <div class="dot" style="top: 24%; left: 39%;" data-side="left" data-index="0"></div>
      <div class="dot" style="top: 38%; left: 39%;" data-side="left" data-index="1"></div>
      <div class="dot" style="top: 55%; left: 39%;" data-side="left" data-index="2"></div>
      <div class="dot" style="top: 70%; left: 39%;" data-side="left" data-index="3"></div>

      <!-- ‡∏à‡∏∏‡∏î‡∏Ç‡∏ß‡∏≤ -->
      <div class="dot" style="top: 24%; left: 62%;" data-side="right" data-index="0"></div>
      <div class="dot" style="top: 38%; left: 62%;" data-side="right" data-index="1"></div>
      <div class="dot" style="top: 55%; left: 62%;" data-side="right" data-index="2"></div>
      <div class="dot" style="top: 70%; left: 62%;" data-side="right" data-index="3"></div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("lineCanvas");
    const ctx = canvas.getContext("2d");
    let leftDot = null;
    let connections = [];
    const correct = [[0, 2], [1, 3], [2, 0], [3, 1]];

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }

    window.addEventListener("resize", resizeCanvas);

    function startMission() {
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("game").style.display = "block";
      resizeCanvas();
      document.getElementById("bgMusic").volume = 0.4;
      document.getElementById("bgMusic").play().catch(() => {});
    }

    document.querySelectorAll(".dot").forEach(dot => {
      dot.addEventListener("click", () => {
        const side = dot.dataset.side;
        const index = parseInt(dot.dataset.index);
        if (side === "left") {
          leftDot = { element: dot, index };
        } else if (leftDot) {
          connections.push([leftDot, { element: dot, index }]);
          leftDot = null;
          drawLines();
          if (connections.length === 4) checkAnswers();
        }
      });
    });

    function drawLines() {
      resizeCanvas();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "#FF0000";
      ctx.lineWidth = 3;

      connections.forEach(([l, r]) => {
        const rect1 = l.element.getBoundingClientRect();
        const rect2 = r.element.getBoundingClientRect();
        const x1 = rect1.left + rect1.width / 2;
        const y1 = rect1.top + rect1.height / 2;
        const x2 = rect2.left + rect2.width / 2;
        const y2 = rect2.top + rect2.height / 2;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      });
    }

    function checkAnswers() {
      let correctCount = 0;
      connections.forEach(([l, r]) => {
        const pair = [l.index, r.index];
        if (correct.some(c => c[0] === pair[0] && c[1] === pair[1])) {
          correctCount++;
        }
      });

      const popup = document.getElementById("popup");
      popup.style.display = "block";

      if (correctCount === 4) {
        popup.innerHTML = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üéâ";
        document.getElementById("successSound").play();
        startFireworks();
        localStorage.setItem("mission2Complete", "true");
        setTimeout(() => window.location.href = "index.html#map", 4000);
      } else {
        document.getElementById("failSound").play();
        popup.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ñ‡∏π‡∏Å ${correctCount} ‡∏Ñ‡∏π‡πà ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
        setTimeout(() => {
          popup.style.display = "none";
          connections = [];
          drawLines();
        }, 3000);
      }
    }

    function startFireworks() {
      const canvas = document.getElementById("fireworks");
      const ctx = canvas.getContext("2d");
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      let particles = [];

      function createFirework() {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height / 2;
        const color = `hsl(${Math.random() * 360}, 100%, 60%)`;

        for (let i = 0; i < 100; i++) {
          particles.push({
            x, y,
            radius: Math.random() * 2 + 1,
            dx: (Math.random() - 0.5) * 5,
            dy: (Math.random() - 0.5) * 5,
            alpha: 1,
            color
          });
        }
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
          p.x += p.dx;
          p.y += p.dy;
          p.alpha -= 0.01;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${hexToRgb(p.color)}, ${p.alpha})`;
          ctx.fill();
          if (p.alpha <= 0) particles.splice(i, 1);
        });
        if (particles.length > 0) requestAnimationFrame(animate);
      }

      function hexToRgb(h) {
        const temp = document.createElement("div");
        temp.style.color = h;
        document.body.appendChild(temp);
        const rgb = window.getComputedStyle(temp).color;
        document.body.removeChild(temp);
        return rgb.match(/\d+,\s*\d+,\s*\d+/)[0];
      }

      createFirework();
      createFirework();
      createFirework();
      animate();
    }

    // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    window.addEventListener('DOMContentLoaded', () => {
      function playVoiceOnce() {
        const voice = document.getElementById("voice");
        voice.play().catch(() => {});
        window.removeEventListener('click', playVoiceOnce);
        window.removeEventListener('touchstart', playVoiceOnce);
      }
      window.addEventListener('click', playVoiceOnce);
      window.addEventListener('touchstart', playVoiceOnce);
    });
  </script>
</body>
</html>
