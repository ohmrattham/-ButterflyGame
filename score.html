<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #FFFBEF;
      color: #333;
      text-align: center;
      padding: 20px;
    }

    h1 {
      color: #8B4513;
      font-size: 2.5em;
    }

    .summary-box {
      background-color: #FFEFD5;
      padding: 20px;
      margin: 20px auto;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .score-row {
      margin: 8px 0;
      font-size: 1.2em;
    }

    .highlight {
      font-weight: bold;
      color: #d2691e;
    }

    .leaderboard {
      margin-top: 40px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #F5DEB3;
      color: #333;
    }

    tr:nth-child(even) {
      background-color: #FAF0E6;
    }

    .back-button {
      margin-top: 30px;
      padding: 10px 24px;
      background-color: #f4a261;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1.1em;
      cursor: pointer;
    }

    .back-button:hover {
      background-color: #e76f51;
    }
  </style>
</head>
<body>

  <h1>üéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
  <div class="summary-box">
    <div class="score-row">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: <span id="nickname" class="highlight">-</span></div>
    <div class="score-row">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="school" class="highlight">-</span></div>
    <hr>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1: <span id="mission1">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2: <span id="mission2">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3: <span id="mission3">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 4: <span id="mission4">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 5: <span id="mission5">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 6: <span id="mission6">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <hr>
    <div class="score-row">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total" class="highlight">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
  </div>

  <div class="leaderboard">
    <h2>üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h2>
    <table>
      <thead>
        <tr>
          <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
          <th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody">
        <tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
      </tbody>
    </table>
  </div>

  <button class="back-button" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>

  <script>
    function getScore(n) {
      return parseInt(localStorage.getItem(`mission${n}Score`)) || 0;
    }

    const nickname = localStorage.getItem("nickname")?.trim() || "-";
    const school = localStorage.getItem("school")?.trim() || "-";

    document.getElementById("nickname").textContent = nickname;
    document.getElementById("school").textContent = school;

    let total = 0;
    for (let i = 1; i <= 6; i++) {
      const score = getScore(i);
      total += score;
      document.getElementById(`mission${i}`).textContent = score;
    }

    document.getElementById("total").textContent = total;

    // ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet
    if (!localStorage.getItem("scoreSent") && nickname !== "-" && school !== "-") {
      const payload = {
        nickname,
        school,
        totalScore: total
      };

      fetch("https://script.google.com/macros/s/AKfycbwLv1QwW6Ca0RcEHjOFcudSIh7Bi0zh6g1bnYa5Jfnq8bLrd9fNr5tky_yphrMyQMQ8VQ/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.text())
      .then(data => {
        console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß:", data);
        localStorage.setItem("scoreSent", "true");
      })
      .catch(err => {
        console.error("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å Google Sheets
    fetch("https://script.google.com/macros/s/AKfycbwLv1QwW6Ca0RcEHjOFcudSIh7Bi0zh6g1bnYa5Jfnq8bLrd9fNr5tky_yphrMyQMQ8VQ/exec")
      .then(res => res.json())
      .then(data => {
        const sorted = data.sort((a, b) => b.totalScore - a.totalScore).slice(0, 5);
        const tbody = document.getElementById("leaderboardBody");
        tbody.innerHTML = "";

        sorted.forEach((player, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${player.nickname}</td>
            <td>${player.school}</td>
            <td>${player.totalScore}</td>
          `;
          tbody.appendChild(row);
        });
      })
      .catch(err => {
        console.error("‡πÇ‡∏´‡∏•‡∏î leaderboard ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        document.getElementById("leaderboardBody").innerHTML = `<tr><td colspan="4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ</td></tr>`;
      });

    function goHome() {
      window.location.href = "index.html";
    }
  </script>

</body>
</html>
