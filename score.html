<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #FFFBEF;
      color: #333;
      text-align: center;
      padding: 20px;
    }

    h1 {
      color: #8B4513;
      font-size: 2.5em;
    }

    .summary-box {
      background-color: #FFEFD5;
      padding: 20px;
      margin: 20px auto;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .score-row {
      margin: 8px 0;
      font-size: 1.2em;
    }

    .highlight {
      font-weight: bold;
      color: #d2691e;
    }

    .leaderboard {
      margin-top: 40px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #F5DEB3;
      color: #333;
    }

    tr:nth-child(even) {
      background-color: #FAF0E6;
    }

    .back-button {
      margin-top: 30px;
      padding: 10px 24px;
      background-color: #f4a261;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1.1em;
      cursor: pointer;
    }

    .back-button:hover {
      background-color: #e76f51;
    }
  </style>
</head>

<body>

  <h1>üéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
  <div class="summary-box">
    <div class="score-row">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: <span id="nickname" class="highlight">-</span></div>
    <div class="score-row">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="school" class="highlight">-</span></div>
    <div class="score-row">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: <span id="rank" class="highlight">-</span></div>
    <hr />
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1: <span id="mission1">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2: <span id="mission2">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3: <span id="mission3">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 4: <span id="mission4">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 5: <span id="mission5">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-row">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 6: <span id="mission6">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <hr />
    <div class="score-row">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total" class="highlight">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
  </div>

  <div class="leaderboard">
    <h2>üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h2>
    <table>
      <thead>
        <tr>
          <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
          <th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody">
        <tr>
          <td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <button class="back-button" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
  <button class="back-button" onclick="endMission()">‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>

  <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏≤‡∏Å localStorage
    function getScore(n) {
      return parseInt(localStorage.getItem(`mission${n}Score`)) || 0;
    }

    const nickname = localStorage.getItem("nickname")?.trim() || "-";
    const school = localStorage.getItem("school")?.trim() || "-";

    document.getElementById("nickname").textContent = nickname;
    document.getElementById("school").textContent = school;

    let total = 0;
    for (let i = 1; i <= 6; i++) {
      const score = getScore(i);
      total += score;
      document.getElementById(`mission${i}`).textContent = score;
    }
    document.getElementById("total").textContent = total;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets
    function sendScore() {
      const data = {
        timestamp: new Date().toISOString(),
        nickname,
        school,
        mission1: getScore(1),
        mission2: getScore(2),
        mission3: getScore(3),
        mission4: getScore(4),
        mission5: getScore(5),
        mission6: getScore(6),
        totalScore: total,
      };

      return fetch(
        "https://script.google.com/macros/s/AKfycbyi40b0fA0BsHWgwDV4vjdR_pptsnmRzvGLEy2dm6xVfz2mB9DlBeDUA_gMFrFAqaKTtw/exec",
        {
          method: "POST",
          body: JSON.stringify(data),
        }
      ).then((res) => res.json());
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• leaderboard ‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    function loadLeaderboard() {
      fetch("https://script.google.com/macros/s/AKfycbyZOZSgmmTnS1FcHnM3VyYWlAV9lyiERv0T16KQ_YtsYUMit7KGJ_OWMTTBzbLQqHmPGw/exec")
        .then((res) => res.json())
        .then((data) => {
          console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API:", data);

          if (!Array.isArray(data)) {
            throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array");
          }

          const sorted = data.sort((a, b) => b.totalScore - a.totalScore);

          const top5 = sorted.slice(0, 5);
          const tbody = document.getElementById("leaderboardBody");
          tbody.innerHTML = "";

          top5.forEach((player, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
          <td>${index + 1}</td>
          <td>${player.nickname}</td>
          <td>${player.school}</td>
          <td>${player.totalScore}</td>
        `;
            tbody.appendChild(row);
          });

          const myIndex = sorted.findIndex(
            (p) =>
              p.nickname === nickname &&
              p.school === school &&
              p.totalScore === total
          );

          const myRank = myIndex >= 0 ? myIndex + 1 : "-";
          document.getElementById("rank").textContent = myRank;
        })
        .catch((err) => {
          console.error("‡πÇ‡∏´‡∏•‡∏î leaderboard ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
          document.getElementById("leaderboardBody").innerHTML =
            `<tr><td colspan="4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ</td></tr>`;
          document.getElementById("rank").textContent = "-";
        });
    }



    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î leaderboard
    // ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏ä‡πá‡∏Å‡∏à‡∏≤‡∏Å localStorage
    if (!localStorage.getItem("scoreSent")) {
      sendScore()
        .then((result) => {
          console.log("‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", result);
          localStorage.setItem("scoreSent", "true"); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
          loadLeaderboard();
        })
        .catch((error) => {
          console.error("‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
        });
    } else {
      console.log("‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á");
      loadLeaderboard();
    }


    function goHome() {
      window.location.href = "index.html";
    }

    function endMission() {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á")) {
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage
        for (let i = 1; i <= 6; i++) {
          localStorage.removeItem(`mission${i}Score`);
        }
        localStorage.removeItem("missionStatus");
        localStorage.removeItem("nickname");
        localStorage.removeItem("playerName");
        localStorage.removeItem("school");
        localStorage.removeItem("scoreSent");
        localStorage.setItem("resetOnLoad", "true");


        alert("‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        window.location.href = "index.html";
      }
    }
  </script>
</body>

</html>